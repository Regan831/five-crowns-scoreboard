generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Player {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  gamePlayers GamePlayer[]
  wentOutFor  Round[]      @relation("RoundWentOutPlayer")
  roundScores RoundScore[]
}

model Game {
  id          String       @id @default(cuid())
  title       String?
  status      GameStatus   @default(IN_PROGRESS)
  secretKey   String       @unique
  createdAt   DateTime     @default(now())
  completedAt DateTime?
  players     GamePlayer[]
  rounds      Round[]
  roundScores RoundScore[]
}

model GamePlayer {
  id         String   @id @default(cuid())
  gameId     String
  playerId   String
  seat       Int
  finalTotal Int?
  isWinner   Boolean  @default(false)
  wentOuts   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player     Player   @relation(fields: [playerId], references: [id])

  @@unique([gameId, playerId])
  @@unique([gameId, seat])
}

model Round {
  id              String       @id @default(cuid())
  gameId          String
  roundNumber     Int
  wentOutPlayerId String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  game            Game         @relation(fields: [gameId], references: [id], onDelete: Cascade)
  wentOutPlayer   Player?      @relation("RoundWentOutPlayer", fields: [wentOutPlayerId], references: [id])
  scores          RoundScore[]

  @@unique([gameId, roundNumber])
}

model RoundScore {
  id        String   @id @default(cuid())
  gameId    String
  roundId   String
  playerId  String
  score     Int
  wentOut   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  round     Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([roundId, playerId])
  @@index([gameId, playerId])
  @@index([roundId, score])
}

enum GameStatus {
  IN_PROGRESS
  COMPLETED
}
